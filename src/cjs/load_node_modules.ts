import { join } from "../../deps.ts";
import { loadAsFile } from "./load_file.ts";
import { loadPackageExports } from "./load_package_exports.ts";
import { loadAsDirectory } from "./load_as_directory.ts";
import type { Context, LoadResult } from "./types.ts";
import type { Subpath } from "../types.ts";

export async function loadNodeModules(
  packageURL: URL,
  subpath: Subpath,
  context: Pick<Context, "conditions" | "mainFields" | "resolve">,
): Promise<LoadResult | false | undefined> {
  const exportsResult = await loadPackageExports(packageURL, subpath, context);

  if (exportsResult) return exportsResult;

  const url = join(packageURL, subpath);

  const loadResult = await loadAsFile(url);
  if (loadResult) return loadResult;

  return loadAsDirectory(url, context);
}
